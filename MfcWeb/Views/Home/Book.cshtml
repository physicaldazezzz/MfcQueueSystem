@model MfcWeb.Models.Service
@{
    ViewData["Title"] = "Запись";
}

<div class="container d-flex justify-content-center align-items-center fade-in" style="min-height: 80vh;">
    <div class="booking-form-container col-md-8 col-lg-6">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">Запись на прием</h2>
            <p class="text-muted">@Model.ServiceName</p>
        </div>

        @if (ViewBag.Error != null)
        {
                <div class="alert alert-danger">@ViewBag.Error</div>
        }

        <form method="post" id="bookingForm">
            <input type="hidden" name="serviceId" value="@Model.ServiceId" />
            <input type="hidden" name="time" id="selectedTime" required />

            <!-- Шаг 1: Контакты -->
            <div class="mb-3">
                <label class="form-label text-muted small">ФИО ЗАЯВИТЕЛЯ</label>
                <input type="text" name="fio" class="form-control" placeholder="Иванов Иван Иванович" required />
            </div>

            <div class="mb-3">
                <label class="form-label text-muted small">ТЕЛЕФОН</label>
                <input type="tel" name="phone" class="form-control" placeholder="+7 (999) 000-00-00" required />
            </div>

            <!-- Шаг 2: Выбор даты -->
            <div class="mb-3">
                <label class="form-label text-muted small">ДАТА ПРИЕМА</label>
                <input type="date" name="date" id="datePicker" class="form-control" required value="@DateTime.Today.ToString("yyyy-MM-dd")" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
            </div>

            <!-- Шаг 3: Слоты времени -->
            <div class="mb-3">
                <label class="form-label text-muted small">ВРЕМЯ ПРИЕМА</label>
                <div id="slotsContainer" class="d-flex flex-wrap gap-2 justify-content-center p-3 bg-light rounded-3" style="min-height: 100px;">
                    <span class="text-muted align-self-center">Загрузка слотов...</span>
                </div>
            </div>

            <button type="submit" class="btn btn-primary-mfc w-100 mt-4 py-3 shadow" id="submitBtn" disabled>
                ПОДТВЕРДИТЬ ЗАПИСЬ
            </button>

            <div class="text-center mt-3">
                <a asp-action="Index" class="text-muted text-decoration-none">Отмена</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            var serviceId = @Model.ServiceId;
            var $datePicker = $('#datePicker');
            var $slotsContainer = $('#slotsContainer');
            var $timeInput = $('#selectedTime');
            var $submitBtn = $('#submitBtn');

            function loadSlots() {
                var date = $datePicker.val();
                if (!date) return;

                $slotsContainer.html('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');
                $timeInput.val('');
                $submitBtn.prop('disabled', true);

                $.get('/Home/GetTimeSlots?serviceId=' + serviceId + '&date=' + date, function(data) {
                    $slotsContainer.empty();
                    
                    if (data.length === 0) {
                        $slotsContainer.html('<span class="text-muted">Нет доступных слотов на этот день</span>');
                        return;
                    }

                    data.forEach(function(slot) {
                        var btnClass = slot.isAvailable ? 'btn-outline-primary' : 'btn-light text-muted border-0';
                        var disabledAttr = slot.isAvailable ? '' : 'disabled';
                        var clickHandler = slot.isAvailable ? 'onclick="selectSlot(this, \'' + slot.time + '\')"' : '';
                        
                        // Если слот занят или прошел - меняем стиль
                        if (!slot.isAvailable) {
                            if (slot.isBusy) {
                                // Занят кем-то
                                btnClass = 'btn-secondary opacity-50 text-decoration-line-through'; 
                            } else if (slot.isPast) {
                                // Прошло время
                                btnClass = 'btn-light text-muted';
                            }
                        }

                        var btn = `<button type="button" class="btn ${btnClass} m-1 slot-btn" ${disabledAttr} ${clickHandler} style="width: 80px;">${slot.time}</button>`;
                        $slotsContainer.append(btn);
                    });
                });
            }

            // Загрузить слоты при загрузке страницы
            loadSlots();

            // При изменении даты
            $datePicker.change(loadSlots);

            // Глобальная функция выбора слота (чтобы работала из HTML строки)
            window.selectSlot = function(btn, time) {
                // Снять выделение со всех
                $('.slot-btn').removeClass('active btn-primary text-white').addClass('btn-outline-primary');
                
                // Выделить текущий
                $(btn).removeClass('btn-outline-primary').addClass('active btn-primary text-white');
                
                // Записать значение
                $timeInput.val(time);
                $submitBtn.prop('disabled', false);
            };
        });
    </script>
}
